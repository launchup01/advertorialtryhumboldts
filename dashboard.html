<!DOCTYPE html>
<html>
<head>
    <title>Facebook Ad Link Protection - Test Dashboard</title>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        .step { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üîí Facebook Ad Link Protection Test</h1>
    
    <div class="test-section info">
        <h2>How It Works</h2>
        <div class="step">
            <strong>Step 1:</strong> Facebook ad clicks go to <code>go.php</code>
        </div>
        <div class="step">
            <strong>Step 2:</strong> <code>go.php</code> verifies it's legitimate Facebook traffic (checks for <code>fbclid</code>)
        </div>
        <div class="step">
            <strong>Step 3:</strong> Creates one-time token and redirects to <code>index.php?t=token</code>
        </div>
        <div class="step">
            <strong>Step 4:</strong> If someone tries to share that URL, token is already used ‚Üí "Link expired"
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ Test Your Setup</h2>
        
        <h3>Test 1: Legitimate Facebook Traffic</h3>
        <button onclick="testLegitimate()">Test go.php (Simulated Facebook Click)</button>
        <p><em>This should work and show your landing page</em></p>
        
        <h3>Test 2: Direct Link Sharing</h3>
        <button onclick="testDirect()">Test index.php directly (No token)</button>
        <p><em>This should show "Access blocked"</em></p>
        
        <h3>Test 3: Token Reuse</h3>
        <button onclick="testReuse()">Generate token, then try to use it twice</button>
        <p><em>First use should work, second should show "Link expired"</em></p>
    </div>

    <div id="results"></div>

    <div class="test-section">
        <h2>üìã Setup Checklist for Facebook Ads</h2>
        <div class="step">
            ‚úÖ <strong>Your Facebook Ad URL should be:</strong><br>
            <code>https://yourdomain.com/go.php</code>
            <br><em>(NOT index.php!)</em>
        </div>
        <div class="step">
            ‚úÖ <strong>Tokens file permissions:</strong> Make sure <code>tokens.txt</code> is writable
        </div>
        <div class="step">
            ‚úÖ <strong>HTTPS:</strong> Use HTTPS in production for secure cookies
        </div>
        <div class="step">
            ‚úÖ <strong>Test mode:</strong> Add <code>?test=1</code> to your go.php URL for testing without Facebook
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function testLegitimate() {
            addResult('üîÑ Testing legitimate Facebook traffic...', 'info');
            window.open('/go.php?test=1', '_blank');
        }

        function testDirect() {
            addResult('üîÑ Testing direct access to index.php...', 'info');
            window.open('/index.php', '_blank');
        }

        async function testReuse() {
            addResult('üîÑ Testing token reuse...', 'info');
            
            try {
                // First, generate a token by visiting go.php
                const response = await fetch('/go.php?test=1', {
                    redirect: 'manual'
                });
                
                if (response.status === 302) {
                    const location = response.headers.get('location');
                    if (location && location.includes('index.php?t=')) {
                        const tokenUrl = location;
                        addResult(`‚úÖ Token generated: <code>${tokenUrl}</code>`, 'success');
                        
                        // Try to use it twice
                        addResult('üìù Opening token URL first time (should work)...', 'info');
                        window.open(tokenUrl, '_blank');
                        
                        setTimeout(() => {
                            addResult('üìù Opening same token URL second time (should show expired)...', 'info');
                            window.open(tokenUrl, '_blank');
                        }, 2000);
                    } else {
                        addResult('‚ùå No redirect to index.php found', 'error');
                    }
                } else {
                    addResult('‚ùå go.php did not redirect properly', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Show current status
        document.addEventListener('DOMContentLoaded', () => {
            addResult(`üåê Testing server: ${window.location.origin}`, 'info');
            addResult('üí° Click the test buttons above to verify your setup', 'info');
        });
    </script>
</body>
</html>
